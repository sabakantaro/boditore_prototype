version: 2
jobs:
  build:
      docker:
        #アプリのバージョンを指定
        - image: circleci/ruby:2.6.5-node-browsers
          environment:
            #自身の登録しているユーザに変える。
            PGHOST: 127.0.0.1
            PGUSER: Snivy
            RAILS_ENV: test
        #使ってるデータベースとバージョンを指定する。# 「host: localhost」でアクセスできるサービスコンテナイメージ。
        - image: circleci/postgres:13.3
          environment:
            #それぞれ設定
            POSTGRES_USER: Snivy
            POSTGRES_DB: ci_test
            POSTGRES_HOST_AUTH_METHOD: trust
            # user: mscrtins
            #下記を書けばパスワードなしでデータベースにログインしてくれる。 
            # password: CVWmQ17SgAdtu3Tw_03pljfWhISxjVIr
            # POSTGRES_HOST_AUTH_METHOD: trust
            # database: mscrtins
      #自身のアプリ名にする
      working_directory: ~/boditore
      steps:
        - checkout
        #bundle キャッシュをリストアする。公式の設定通り。
        - restore_cache:
            keys:
              - v1-dependencies-{{ checksum "Gemfile.lock" }}
              - v1-dependencies-
        # bundle install で依存関係をインストールする。公式の設定と多少異なってます。
        - run:
            name: install dependencies
            command: |
              gem install bundler -v 2.2.25
              bundle install --jobs=4 --retry=3 --path vendor/bundle

        # bundle キャッシュを保存する。公式の設定通り。
        - save_cache:
            key: v1-dependencies-{{ checksum "Gemfile.lock" }}
            paths:
              - ./vendor/bundle

        #↓追加する
        - run:
            name: DBの起動を待つ
            command: dockerize -wait tcp://127.0.0.1:5432 -timeout 120s

        - run: bundle exec rake db:create
        - run: bundle exec rake db:schema:load

        # rspecを実行する
        - run:
            name: rspecを実行
            command: bundle exec rspec
#awsデプロイ
        - add_ssh_keys:
            fingerprints:
              - 56:2b:01:5c:56:0c:a6:31:2d:98:f1:84:c9:4b:8f:db
        # masterブランチの時のみデプロイ
        - deploy:
            name: Capistrano deploy
            command: |
              if [ "${CIRCLE_BRANCH}" != "master" ]; then
                exit 0
              fi
              bundle exec cap production deploy